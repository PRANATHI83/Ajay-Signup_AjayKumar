<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forgot Password</title>

    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
        /* Keep your original styles here */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 50px 20px;
        }

        .form-container {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        h2 {
            text-align: center;
            color: #0077ff;
            margin-bottom: 20px;
        }

        .input-container {
            position: relative;
            margin-bottom: 20px;
        }

        .input-container input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        .input-container label {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }

        .eye-icon, .info-icon {
            position: absolute;
            right: 10px;
            top: 38px;
            cursor: pointer;
        }

        .form-button {
            width: 100%;
            padding: 12px;
            background-color: #0077ff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }

        .form-button:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        .checkmark {
            position: absolute;
            right: 10px;
            top: 10px;
            color: green;
            display: none;
        }

        .checkmark.invalid {
            color: red;
        }

        .error-message {
            font-size: 12px;
            color: red;
            margin-top: 4px;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            color: white;
            font-size: 14px;
            z-index: 1000;
            animation: fadeOut 3s forwards;
        }

        .alert.success {
            background-color: green;
        }

        .alert.error {
            background-color: red;
        }

        @keyframes fadeOut {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }

        .links {
            margin-top: 20px;
            text-align: center;
        }

        .links a {
            text-decoration: none;
            color: #0077ff;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            position: relative; /* Added for modal close button positioning */
        }

        .modal-content h3 {
            margin-top: 0;
        }

        .modal-content ul {
            padding-left: 20px;
        }

        .modal-content button.close-modal-btn { /* Changed class name for specificity */
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }

        /* NEW STYLES for requestPasswordReset flow */
        #requestResetForm, #resetPasswordForm {
            display: none; /* Initially hide both forms */
        }

        #requestResetForm.active, #resetPasswordForm.active {
            display: block; /* Show active form */
        }
        /* END NEW STYLES */
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <h2 id="form-title">Forgot Password</h2> <form id="requestResetForm" class="active"> <p>Enter your email to receive a password reset link.</p>
                <div class="input-container">
                    <label for="requestEmail">Email</label>
                    <input type="email" id="requestEmail" placeholder=" " required />
                    <div id="request-email-error" class="error-message"></div>
                </div>
                <button type="submit" id="sendResetLinkBtn" class="form-button">
                    Send Reset Link
                </button>
            </form>
            <form id="resetPasswordForm"> <p id="reset-password-intro">Enter your new password.</p> <div class="input-container password-container">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" placeholder=" " required />
                    <span class="eye-icon" onclick="togglePassword('newPassword')">üëÅÔ∏è</span>
                    <span class="info-icon" onclick="toggleModal()">‚ÑπÔ∏è</span>
                    <span id="new-password-checkmark" class="checkmark">‚úì</span>
                    <div id="new-password-error" class="error-message"></div>
                </div>

                <div class="input-container password-container">
                    <label for="confirmNewPassword">Confirm Password</label>
                    <input type="password" id="confirmNewPassword" placeholder=" " required />
                    <span class="eye-icon" onclick="togglePassword('confirmNewPassword')">üëÅÔ∏è</span>
                    <span id="confirm-password-checkmark" class="checkmark">‚úì</span>
                    <div id="confirm-password-error" class="error-message"></div>
                </div>

                <button type="submit" id="finalResetPasswordBtn" class="form-button" disabled> Reset Password
                </button>
            </form>
            <div class="links">
                <a href="http://65.2.166.147:8023/">Back to Login</a>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <button onclick="toggleModal()" class="close-modal-btn">√ó</button> <h3>Password Requirements</h3>
            <ul>
                <li>Minimum 8 characters</li>
                <li>At least one uppercase letter</li>
                <li>At least one number</li>
                <li>At least one special character (!@#$%^&*)</li>
            </ul>
        </div>
    </div>

    <script>
        // NEW GLOBAL VARIABLE: Store the token
        let resetToken = null; 

        // Initial state for password reset form validation
        let isNewPasswordValid = false;
        let isConfirmPasswordValid = false;

        // NEW: Function to parse URL parameters
        function getQueryParams() {
            const params = {};
            window.location.search.substring(1).split('&').forEach(param => {
                const parts = param.split('=');
                if (parts.length === 2) {
                    params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1]);
                }
            });
            return params;
        }

        // NEW: Function to show/hide forms based on token presence
        function initializePage() {
            const queryParams = getQueryParams();
            resetToken = queryParams.token; // Get token from URL

            const requestResetForm = document.getElementById('requestResetForm');
            const resetPasswordForm = document.getElementById('resetPasswordForm');
            const formTitle = document.getElementById('form-title');
            const resetPasswordIntro = document.getElementById('reset-password-intro');
            
            if (resetToken) {
                // If token exists, display the password reset form
                requestResetForm.classList.remove('active');
                resetPasswordForm.classList.add('active');
                formTitle.textContent = 'Set New Password';
                resetPasswordIntro.textContent = 'Enter your new password.';
                // If you want to auto-fill email from the token, you'd do it here
                // For a secure flow, the backend uses the token to identify the user
                // so email input is not strictly needed on this form.
            } else {
                // If no token, display the email request form
                requestResetForm.classList.add('active');
                resetPasswordForm.classList.remove('active');
                formTitle.textContent = 'Forgot Password';
            }
            updateResetButton(); // Check button state after initialization
        }

        function showAlert(type, message) {
            const alert = document.createElement("div");
            alert.className = `alert ${type}`;
            alert.innerHTML = `<i class="fas fa-${type === "success" ? "check-circle" : "exclamation-circle"}"></i> ${message}`;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        function togglePassword(id) {
            const input = document.getElementById(id);
            const icon = input.parentElement.querySelector(".eye-icon");
            input.type = input.type === "password" ? "text" : "password";
            icon.textContent = input.type === "password" ? "üëÅÔ∏è" : "üîì";
        }

        function toggleModal() {
            const modal = document.getElementById("passwordModal");
            modal.style.display = modal.style.display === "flex" ? "none" : "flex";
        }

        // CHANGED: Update this function to only rely on new password validation
        function updateResetButton() {
            const finalResetBtn = document.getElementById("finalResetPasswordBtn");
            if (finalResetBtn) { // Ensure button exists on the current active form
                finalResetBtn.disabled = !(isNewPasswordValid && isConfirmPasswordValid);
            }

            // NEW: Also enable/disable the "Send Reset Link" button
            const sendResetLinkBtn = document.getElementById("sendResetLinkBtn");
            if (sendResetLinkBtn) {
                const requestEmail = document.getElementById('requestEmail').value.trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                sendResetLinkBtn.disabled = !emailRegex.test(requestEmail);
            }
        }

        // REMOVED: checkEmail function as it's not needed for the token-based reset form
        // It might be needed on the backend for the *initial* send-reset-link request.

        function validateNewPassword() {
            const pwd = document.getElementById("newPassword").value;
            const error = document.getElementById("new-password-error");
            const check = document.getElementById("new-password-checkmark");

            const regex = /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*]).{8,}$/;
            if (!pwd) {
                error.textContent = "Password required";
                check.style.display = "none";
                isNewPasswordValid = false;
            } else if (!regex.test(pwd)) {
                error.textContent = "Weak password (min 8 chars, 1 uppercase, 1 number, 1 special char)"; // More specific message
                check.style.display = "none";
                isNewPasswordValid = false;
            } else {
                error.textContent = "";
                check.style.display = "block";
                isNewPasswordValid = true;
            }
            validateConfirmPassword(); // Ensure confirm password validates immediately
            updateResetButton();
        }

        function validateConfirmPassword() {
            const pwd = document.getElementById("newPassword").value;
            const confirm = document.getElementById("confirmNewPassword").value;
            const error = document.getElementById("confirm-password-error");
            const check = document.getElementById("confirm-password-checkmark");

            if (pwd !== confirm || !confirm) {
                error.textContent = "Passwords do not match";
                check.style.display = "none";
                isConfirmPasswordValid = false;
            } else {
                error.textContent = "";
                check.style.display = "block";
                isConfirmPasswordValid = true;
            }
            updateResetButton();
        }

        // NEW EVENT LISTENER: For the email input on the requestResetForm
        document.getElementById("requestEmail").addEventListener("input", (e) => {
            const email = e.target.value.trim();
            document.getElementById("request-email-error").textContent = ""; // Clear error
            updateResetButton(); // Update button state
        });

        // Event listeners for the password reset form (only active if token is present)
        document.getElementById("newPassword").addEventListener("input", validateNewPassword);
        document.getElementById("confirmNewPassword").addEventListener("input", validateConfirmPassword);


        // NEW EVENT LISTENER: For submitting the "Request Reset Link" form
        document.getElementById("requestResetForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("requestEmail").value.trim();
            const errorElement = document.getElementById("request-email-error");

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorElement.textContent = "Please enter a valid email address.";
                showAlert("error", "Invalid email format.");
                return;
            }

            try {
                // IMPORTANT: This endpoint is for SENDING the reset email with a token
                const res = await fetch("http://65.2.166.147:3011/api/forgot-password-request", { // CHANGED: New backend endpoint
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                if (res.ok) { // Check for successful HTTP status (e.g., 200-299)
                    showAlert("success", data.message || "Password reset link sent to your email!");
                    // Optionally, clear the email field after successful request
                    document.getElementById("requestEmail").value = '';
                    updateResetButton(); // Update button state
                } else {
                    showAlert("error", data.error || "Failed to send reset link.");
                    errorElement.textContent = data.error || "Failed to send reset link.";
                }
            } catch (err) {
                showAlert("error", "Error connecting to server. Please try again later.");
                errorElement.textContent = "Error connecting to server.";
            }
        });


        // CHANGED EVENT LISTENER: For submitting the "Reset Password" form (with token)
        document.getElementById("resetPasswordForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            // Ensure client-side validation passes before submitting
            validateNewPassword();
            validateConfirmPassword();

            if (!(isNewPasswordValid && isConfirmPasswordValid)) {
                showAlert("error", "Please fix password errors.");
                return;
            }
            
            // CRITICAL: Ensure token exists for this submission
            if (!resetToken) {
                showAlert("error", "Missing reset token. Please use the link from your email.");
                return;
            }

            const newPassword = document.getElementById("newPassword").value;
            // No need to send confirmNewPassword to backend, it's a frontend check
            
            try {
                // IMPORTANT: This endpoint is for RESETTING the password using the token
                const res = await fetch("http://65.2.166.147:3011/api/reset-password", { // CHANGED: New backend endpoint
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ token: resetToken, newPassword: newPassword }) // CHANGED: Sending token and newPassword
                });
                const data = await res.json();
                if (res.ok) { // Check for successful HTTP status (e.g., 200-299)
                    showAlert("success", data.message || "Password has been reset successfully!");
                    setTimeout(() => {
                        window.location.href = "http://65.2.166.147:8023/"; // Redirect to Login Page
                    }, 3000);
                } else {
                    // Specific error for token invalid/expired, etc.
                    showAlert("error", data.error || "Failed to reset password. Token might be invalid or expired.");
                }
            } catch (err) {
                showAlert("error", "Error connecting to server. Please try again later.");
            }
        });

        // Initialize the page on load to check for token and show correct form
        window.addEventListener("load", initializePage);

        window.addEventListener("click", (e) => {
            const modal = document.getElementById("passwordModal");
            if (e.target === modal) {
                modal.style.display = "none";
            }
        });
    </script>
</body>
</html>